# PostgreSQL 开发规范

依据约束力强弱及故障敏感性，规约依次分为【强制】、【推荐】、【参考】三大类。


## 基础规范

1. 【强制】代码不能自己手动拼接字符串生成 sql，需使用对应驱动 Driver API 的占位符方式（黄灯行为）。
2. 【强制】查询必须命中索引（黄灯行为）。
3. 【强制】统一使用 utf8 字符集。
4. 【强制】统一设置时区 Asia/Shanghai。
5. 【推荐】统一使用默认的 public schema，减少使用复杂度，与其他数据库逻辑层保持一致 (库，表，字段)。
6. 【推荐】存储计算分离，将数据处理逻辑和过程约束设计在业务层。
7. 【推荐】每个业务线使用独立的账号和数据库。
8. 【强制】新建数据库 Postgre 数据库实例必须选用 14+版本。
9. 【强制】禁止使用外键。


## 设计建造规范


### 命名规范

1. 【强制】库名、表名、字段名、索引名必须使用小写字母并采用下划线分割。
2. 【强制】库名、表名、字段名、禁止超过 32 个字符，杜绝完全不规范的英文缩写，须见名知意。
3. 【强制】库名、表名、字段名、索引名禁止使用 PostgreSQL 保留关键字，如 `pg`。可以通过 ` SELECT pg_get_keywords ();` 命令查看保留字。
4. 【强制】索引名字以 idx_tableName_columnName 方式命名 (除了 primay key)，复合索引只写第一个字段名，避免命名冲突以及重复创建索引。
5. 【强制】临时库、临时表名必须以 tmp 为前缀并以日期_YYYYMMDD 为后缀。
6. 【强制】备份库、备份表名必须以 bak 为前缀并以日期_YYYYMMDD 为后缀。


### 库设计规范

1. 【强制】PostgreSQL 默认不支持跨数据库查询，同一个业务线的 Table 必须创建在同一个 Database 中，以支持关联查询。
2. 【建议】通过 PostgreSQL Schema 来组织和管理同一个业务线下的 Table，可以按模块来区分。
3. 【强制】显式设置字符集为 UTF-8。如 `CREATE DATABASE xxx_pay_gateway WITH OWNER=user_pay_gateway ENCODING='UTF-8';`
4. 【推荐】创建数据库的同时绑定账号
5. 【推荐】不建议使用自定义函数
6. 【推荐】不建议使用存储过程
7. 【推荐】不建议使用触发器
8. 【推荐】不建议使用视图


### 表设计规范

#### 字段

1. 【强制】PostgreSQL 不支持修改表字段顺序，在设计表字段时，尽量统一字段顺序，保证易用性。
2. 【强制】在已有业务表上修改、增加字段时不能直接附带默认值 Default Expression，应该修改好字段后再通过 UPDATE 更新数据行的方式来设置默认值 Default Expression，否则有 DDL 锁表时间过长的风险 （红灯行为：DDL 会锁表，可能导致读写长时间阻塞业务终止）。
3. 【强制】每个表必须设置 id 字段，而且类型为 bigserial，设置为主键。
4. 【强制】针对字符串存储，字段类型使用 `varchar(n)` 或者 `text`，避免使用 `char(n)`，因为 `char` 的字符长度不够时，在右侧填充空格。
5. 【强制】必须给每个字段设定默认值，增加 NOT NULL 限制，避免排序问题和判断逻辑遗漏。
6. 【推荐】针对整数存储，字段类型默认使用 4 字节的 integer，若数值很大，使用 8 字节的 bigint。
7. 【推荐】针对浮点数存储，REAL 是 4 字节存储，FLOAT 是 8 字节存储，根据精度需求选择。
8. 【推荐】针对精确性数值，比如金钱，使用 `NUMERIC(precision, scale)`，注意设置精度和小数的大小，NUMERIC 类型计算开销很大，只在必须场景使用，不能用来代替浮点型。
9. 【推荐】建议增加 created_at 字段，类型为 `timestampz (timestamp with time zone)`，默认值为 `now()`。
10. 【推荐】建议增加 updated_at 字段，类型为 `timestampz (timestamp with time zone)`。
11. 【推荐】预期超过 5E 条数据或者超过 50GB 的表，在设计初就要考虑垂直拆分或者水平拆分。
12. 【推荐】避免大宽表设计，单表字段不应超过 30 个。

#### 索引

1. 【强制】禁止使用外键
2. 【强制】必须使用 `CONCURRENTLY` 关键字在线创建索引，避免阻塞 DML (INSERT, UPDATE, DELETE) 操作，否则会阻塞 DML 操作（红灯行为）。如：`create index CONCURRENTLY idx_id on tbl(id);`
3. 【强制】禁止在超过 24 个字符的字段上直接加索引，针对大字段，可以设计部分索引，部分索引的字符数控制在 24 个以内
4. 【推荐】默认使用 bTree 索引，btree 索引字段不建议超过 2000 字节，如果有超过 2000 字节的字段需要建索引，建议使用函数索引（例如哈希值索引），或者使用分词索引
5. 【推荐】控制每个表的索引数量，建议单表索引数量控制在 5 个以内
6. 【推荐】控制联合索引的字段数量，建议控制在 3 个及以内
7. 【强制】数据批量导入 PG 的场景，需要先导数据，后建索引


## 查询使用规范

1. 【强制】列表查询必须加 limit (建议大小为 20) （红灯行为：容易打爆应用内存、也容易导致 PG 负载过高）
2. 【强制】禁止全表扫描查询
3. 【强制】禁止在事务中进行长时间等待
4. 【强制】禁止在代码中注入 DDL 语句，导致表结构变更，索引变更
5. 【强制】禁止一次性对大量数据进行事务操作, 应该转换成多次小批量数据操作
6. 【推荐】应用开发的时候要考虑读写分离的设计，确保主从的压力均衡
7. 【推荐】将大 SQL 拆分成小 SQL, 减少数据库性能抖动，减少应用内存开销
8. 【推荐】尽量避免 SELECT * 类型的 SQL，尽量明确查询字段，降低 IO 吞吐量，提升查询效率

## 参考链接

1. [PostgreSQL 中文社区-PostgreSQL 数据库开发规范](https://mp.weixin.qq.com/s/qOobyeo3ROnFnA4NAbG4fg)
2. [Pg 使用规范]( https://wiki.sqlfans.cn/postgresql/pg-std-using.html )
3. [PostgreSQL 中文社区-探探 PostgreSQL 开发规约](https://mp.weixin.qq.com/s/WV9EKnp155MHMpSuXCOFnA)
4. [阿里云社区-PostgreSQL 数据库开发规范](https://developer.aliyun.com/article/60899)
