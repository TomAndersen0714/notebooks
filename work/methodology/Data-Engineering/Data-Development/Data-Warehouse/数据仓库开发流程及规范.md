# 数据仓库开发流程及规范

开发流程：技术方案设计-指标拆解，技术方案设计-一致性维度核对

总的来说，数仓开发和传统的软件开发和数据库开发流程上区别不大，基本也是三步走，即分析—设计—实现


**分析：**
1. 分析阶段，主要采用的是**自顶向下**的思想。
2. 主要内容是**梳理**需求方的指标需求，并将其**拆分**、**翻译**为数仓的标准指标定义的形式，即通常为“时间周期+修饰词（非时间粒度）+原子指标聚合”，并判断指标是否为可加性指标，即同粒度指标相加后，依旧具有类似的实际业务含义，如：按照子账号的粒度聚合后的会话量，多个子账号的会话量相加，依旧具备实际业务含义，但 uv 类指标直接相加通常无实际含义。
3. 其中需要注意的是，在计算某些比较复杂的指标时，需同时先统计组成此指标的一些前置指标（如：比值类指标，需要先计算其分子分母对应的指标），进行纵向的拆分，这会导致实际开发的指标，会多于需求文档中明面上列出的指标。在数仓开发的分析阶段，一定要将这些指标明确下来，避免设计和工作量预估错误。

**设计：**
1. 设计阶段，主要采用的是**自底向上**的思想。
2. 主要内容是进行数仓模型的设计，即统计表的**表结构设计**。数仓中的所有指标统计表，都存在其相应的粒度，设计阶段主要是为了确定分析阶段中梳理出的指标应该存放在哪种粒度的统计表中，本阶段可以利用数据字典来查阅目前已经存在的数据表的粒度。
3. 如果已经存在对应粒度的统计表，则直接通过增加新的指标字段即可；如果不存在对应粒度的统计表，对于可加性指标而言，可以尝试寻找更细粒度的统计表，在其中添加对应的指标，在查询时进行聚合，或者从原始业务表中，自底向上进行构建新的统计表；而对于不可加性指标（如：uv 等），则需要直接创建对应粒度的新表，用于存放对应粒度下的指标。
4. 设计阶段完成后，便可以确定，本次需求中，有哪些表结构发生了变动，哪些指标需要入库实现定时触发统计。

**实现：**
1. 设计阶段完成之后，便是具体的**代码实现**过程，而其中具体的代码，目前多以**SQL**为主。
2. 与传统的数据库开发类似，数仓开发通常也会包含数据完整性约束规则的开发，以保证数据质量。
3. 开发上线完成后，还需要收集代码实现过程中，所有实际发生过的模型（即表结构和字段）变动信息，并将其更新到数据字典中，便于后续在开发同数据域的需求时，能快速判断是否需要新增或使用现有模型，同时提升数据的可复用性，减少元数据的沟通成本。

## 需求阶段

### 需求分析




可行性分析：数据探查

## 设计阶段

数据集成：数据ETL


数仓搭建：数仓开发


数据消费：
1. 数据查询接口开发
2. 数据查询结果可视化


## 开发阶段


不可加性指标，应改拆解为可加性指标


## 测试阶段


功能测试
性能测试

先自测，后提交测试


### BUG排查流程

BUG的定义：BUG指的是，程序设计上的错误，通常表现在算法和数据等方面，使得程序的结果和预期不符。在功能上的表现就是，**程序的运行结果，和需求文档中的需求定义不符**。

排查流程的主体思想：自顶向下，对比基准，抽丝剥茧

#### 定位

定位指标异常值对应的具体行记录
如：在数据可视化界面上，粒度通常等价于筛选条件，即维度的组合，通过筛选条件，可以定位到异常指标的具体行记录


#### 复现

测服使用指标异常值依赖的基础数据重现BUG
抽取线上对应异常指标，在指定粒度下，直接依赖的所有数据（包括明细和维度数据，但仅抽取直接依赖的），将线上明细数据抽取到测服，回放对应任务，重现问题，还原线上环境。


#### 对比

确定对应的基准值并对比两者的算法和基础数据
通过OLAP即席查询系统，对比基准值和异常值之间的算法和基础数据，并抽取和生成Bad Case。

**和自己比的异常**，如：发现指标波动异常，则比较对象是上一周期产生的指标值，而先对比两者的算法，如果算法一致，则可以使用关联查询（JOIN）对比其基础数据（明细数据、维度数据）

**和其他比的异常**，如：发现两个类似的指标之间，数值差别巨大，则将其中的一个指标值视为基准值，另一个指标值视为异常值，先对比两者的算法，如果算法一致，则可以使用关联查询（JOIN）对比其基础数据（明细数据、维度数据）

通过对比各个Bad Case，可以确定指标是否真实存在异常。


#### 下钻

排查指标统计算法，以及基础数据ETL算法
通过重现和对比，发现指标的值确实存在异常后，则需要定位具体问题是在于统计算法，还是指标的基础数据ETL算法，亦或是基础数据的数据质量。

通过对比中抽取出的Bad Case，逐步分析完整的ETL链条，定位BUG点。



### 数仓BUG常见原因

数据查询和可视化问题


统计表计算逻辑问题


明细表计算逻辑问题


数据质量问题


## 发布阶段


## 运维阶段

开发人员根据需求将代码发布上线后，还需要及时处理数据、程序、调度、监控告警等的异常事件，保障数据产出时效、程序高效运行和生产稳定。


其中在“运维阶段”的“获取异常”阶段，可能是通过`运维人员`发现指标监控、计算任务、服务等出现异常，及时抛出并传递给`开发人员`，也可能是上层`业务人员`发现指标结果和需求描述不符，确定是BUG后，向下反馈并传递给`开发人员`的。


### 异常处理流程

#### 系统告警


#### 业务反馈

##### 确定异常原因是BUG，还是功能不符合客户心理预期

`测试人员`，通过排查随机抽样等方式，来判断数据计算逻辑是否符合需求文档中对于需求的定义，如果不符合，则属于BUG；如果符合，则代表异常原因是功能不符合客户心理预期。


##### 如果是BUG，则走BUG排查流程
问题原因通常在于研发人员、测试人员，又或者是需求描述没有对齐
1. 产品经理和研发、测试之间需求定义没有对齐
2. 研发人员未能按照需求文档实现对应的功能
3. 测试人员测试不够严谨


##### 如果是不符合客户心理预期，则走需求变更流程
问题原因通常在于产品经理，事先未清晰对接客户需求


## 参考链接
1. [大数据开发治理平台 DataWorks-研发规范](https://help.aliyun.com/document_detail/115489.html)
2. [大数据开发治理平台 DataWorks-研发规范.pdf](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/download%2Fpdf%2F115489%2F%25E7%25A0%2594%25E5%258F%2591%25E8%25A7%2584%25E8%258C%2583_cn_zh-CN.pdf)