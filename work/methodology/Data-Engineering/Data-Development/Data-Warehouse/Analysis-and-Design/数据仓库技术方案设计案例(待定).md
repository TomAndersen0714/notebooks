# 数据仓库技术方案设计案例 (待定)


数据产品设计中心思想：数据PM的脑中存在的模型，通常仅仅是概念模型，更专业的PM会自己构建对应的逻辑模型，可能是Excel等样式

技术方案设计中心思想：理解产品的概念模型设计，基于数仓ODS层，自顶向下分析拆解、自底向上合并实现。

PS：不论是离线还是在线，数仓的底座ods层关系模型，理论上是完全对齐上游数据源，以一定的数据冗余，减小问题排查时的开销。值得注意的是，如果上游的表名、字段名、主键等内容，存在明显错误，则可以适当调整正确，保证和大环境对齐，后续技术方案的需求梳理、数仓设计等环节，皆以此ods层为基础。


## 需求描述

1. 产品需求文档地址：[221208【明察】质检诊断报告二期](https://xiaoduoai.feishu.cn/wiki/wikcnOprBmnbNOEXqxjKFqXpVud) 
2. 产品原型地址：https://lanhuapp.com/web/#/item/project/product?pid=dfa31128-6abb-4a7f-a5cf-1b465ea078c6
3. 产品需求工单：https://project.feishu.cn/dev_demands/story/detail/2888719?parentUrl=%2Fworkbench#detail


## 需求分析

### 1. 指标需求梳理

[质检诊断数据指标需求梳理](https://xiaoduoai.feishu.cn/sheets/shtcnj6hoqUEzfmgx1krNtxh8De?sheet=azvcOW) 

### 2. 指标需求分析

[质检诊断数据指标需求分析](https://xiaoduoai.feishu.cn/sheets/shtcnajUoacHtgPwwTNVwEXtwkc?sheet=1dvvki) 

### 3. ETL需求分析
依据**指标需求分析**的结果


### 4. 数据字典

[明察质检数据字典（大数据侧）](https://xiaoduoai.feishu.cn/docs/doccnDSC1UBuow5rrVo9dqSq1Ee) 



## 方案设计

### 数据集成方案设计

根据指标需求分析判断，无新增数据源，即无新增数据集成


### 数仓搭建方案设计


#### 统计指标梳理

通过指标需求分析判断，本次需求需要统计的基础指标，以及是否新增指标入库情况如下：

| 指标拆分                |              |                                                          |                |                    |                                          |                    |                          |                            |
| ----------------------- | ------------ | -------------------------------------------------------- | -------------- | ------------------ | ---------------------------------------- | ------------------ | ------------------------ | -------------------------- |
| 基础指标                | 时间维度粒度 | 非时间维度粒度                                           | 是否可加性指标 | 非维度属性筛选粒度 | 非维度属性筛选条件                       | 是否直接查询业务表 | 是否需要需要新增指标入库 | 数据源                     |
| 质检会话量              | 天           | 质检标准、店铺、子账号分组                               | 是             |                    |                                          | 否                 | 否                       | xqc_dws.snick_stat_all     |
| 合格会话量              | 天           | 质检标准、店铺、子账号分组                               | 是             | 会话               | 会话分值大于指定合格分                   | 是                 | 否                       | dwd.xdqc_dialog_all        |
| 扣分会话量              | 天           | 质检标准、店铺、子账号分组、质检项一级分组               | 否             |                    |                                          | 否                 | 否                       | xqc_dws.tag_group_stat_all |
| 质检会话量1             | 天           | 质检标准、店铺、子账号分组、子账号、客服                 | 是             |                    |                                          | 否                 | 否                       | xqc_dws.snick_stat_all     |
| 合格会话量1             | 天           | 质检标准、店铺、子账号分组、子账号、客服                 | 是             | 会话               | 会话分值大于指定合格分                   | 是                 | 否                       | dwd.xdqc_dialog_all        |
| 客服人数                | 天           | 质检标准、店铺、子账号分组、子账号、客服、会话满意率分组 | 是             |                    |                                          | 是                 | 否                       | dwd.xdqc_dialog_all        |
| 检出会话量              | 天           | 质检标准、店铺、子账号分组、质检项                       | 是             |                    |                                          | 否                 | 是                       | xqc_dws.tag_stat_all       |
| （人工质检）质检会话量  | 天           | 质检标准、店铺、子账号分组                               | 是             | 会话               | 存在人工质检标记                         | 否                 | 否                       | xqc_dws.snick_stat_all     |
| （人工质检）合格会话量  | 天           | 质检标准、店铺、子账号分组                               | 是             | 会话               | 会话分值大于指定合格分、存在人工质检标记 | 是                 | 否                       | dwd.xdqc_dialog_all        |
| （人工质检）扣分会话量  | 天           | 质检标准、店铺、子账号分组、质检项一级分组               | 否             | 会话               | 存在人工质检标记                         | 否                 | 是                       | xqc_dws.tag_group_stat_all |
| （人工质检）质检会话量1 | 天           | 质检标准、店铺、子账号分组、子账号、客服                 | 是             | 会话               | 存在人工质检标记                         | 否                 | 否                       | xqc_dws.snick_stat_all     |
| （人工质检）合格会话量1 | 天           | 质检标准、店铺、子账号分组、子账号、客服                 | 是             | 会话               | 会话分值大于指定合格分、存在人工质检标记 | 是                 | 否                       | dwd.xdqc_dialog_all        |
| （人工质检）客服人数    | 天           | 质检标准、店铺、子账号分组、子账号、客服、会话满意率分组 | 是             | 会话               | 存在人工质检标记                         | 是                 | 否                       | dwd.xdqc_dialog_all        |
| （人工质检）检出会话量  | 天           | 质检标准、店铺、子账号分组、质检项                       | 是             | 会话               | 存在人工质检标记                         | 否                 | 是                       | xqc_dws.tag_stat_all       |

#### 具体模型设计

##### xqc_dws.tag_stat_all

粒度：时间（day）\*平台\*店铺\*子账号\*质检项分组\*质检项

新增指标：检出会话量、检出会话量（仅人工质检过的会话）

| 字段名            | 类型 | 描述                                                     | 备注                                                     | 示例值 |      |      |      |
| --------------------- | -------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ---------- | ---- | ---- | ---- |
| day                   | Int32    |                                                              |                                                              |            |      |      |      |
| platform              | String   |                                                              |                                                              |            |      |      |      |
| seller_nick           | String   |                                                              |                                                              |            |      |      |      |
| snick                 | String   |                                                              |                                                              |            |      |      |      |
| tag_group_id          | String   | 质检项分组ID                                                 |                                                              |            |      |      |      |
| tag_group_name        | String   | 质检项分组名                                                 |                                                              |            |      |      |      |
| tag_type              | String   | 质检项类型                                                   | ai_abnormal、ai_excellent、ai_c_emotion、ai_s_emotionmanual_subtract、manual_addcustom_subtract、custom_addcustom_message、custom_dialog |            |      |      |      |
| tag_id                | String   | 质检项ID                                                     |                                                              |            |      |      |      |
| tag_name              | String   | 质检项名                                                     |                                                              |            |      |      |      |
| tag_cnt_sum           | Int64    | 质检项触发次数                                               |                                                              |            |      |      |      |
| tag_score_sum         | Int64    | 质检项分值总数                                               |                                                              |            |      |      |      |
| tag_dialog_cnt        | Int64    | 检出会话量、打标会话量                                       |                                                              |            |      |      |      |
| tag_manual_dialog_cnt | Int64    | 检出会话量（仅人工质检过的会话）、打标会话量（仅人工质检过的会话） |                                                              |            |      |      |      |

##### xqc_dws.tag_group_stat_all

粒度：时间（day）\*平台\*店铺\*子账号\*质检项分组

新增指标：扣分会话量（仅人工质检过的会话）

| 字段名                       | 类型 | 描述                         | 备注 | 示例值 |      |      |      |
| -------------------------------- | -------- | -------------------------------- | -------- | ---------- | ---- | ---- | ---- |
| day                              | Int32    |                                  |          |            |      |      |      |
| platform                         | String   |                                  |          |            |      |      |      |
| seller_nick                      | String   |                                  |          |            |      |      |      |
| snick                            | String   |                                  |          |            |      |      |      |
| qc_norm_id                       | String   | 质检标准ID                       |          |            |      |      |      |
| tag_group_id                     | String   | 质检项分组                       |          |            |      |      |      |
| tag_group_level                  | Int64    | 质检项分组等级                   |          |            |      |      |      |
| add_score_dialog_cnt             | Int64    | 加分会话数                       |          |            |      |      |      |
| subtract_score_dialog_cnt        | Int64    | 扣分会话数                       |          |            |      |      |      |
| subtract_score_manual_dialog_cnt | Int64    | 扣分会话数（仅人工质检过的会话） |          |            |      |      |      |


### 数据查询与可视化方案设计

根据指标需求分析可知，数据可视化查询共计20个子模块，即查询SQL共计20个，查询涉及指标共计70个，需可视化指标44个

可视化界面（基于dataforce）设计如下：

https://dataforce.xiaoduoai.com/619cb6b2181e36bb183e60a0/62f249e50c010945e7c03289?page=63902ef83a84c69ad8981a3b

https://dataforce.xiaoduoai.com/619cb6b2181e36bb183e60a0/62f249e50c010945e7c03289?page=639402303a84c69ad898447d