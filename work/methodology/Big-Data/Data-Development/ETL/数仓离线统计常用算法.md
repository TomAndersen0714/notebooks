# 数仓离线统计常用算法


## 去重计数

每次在指定时间窗口内进行去重计数时，如果此时间窗口的长度固定，则是“固定时间窗口去重”计数，相反如果时间窗口的长度不固定，则称为“动态时间窗口去重”计数。

假设，指标统计时的时间维度粒度为d（天），统计周期为1d（即T+1统计），则指标“每天的近七天网页访问uv数”就属于“固定时间窗口去重”，即每天统计过去7天的去重计数。

而在“动态时间窗口去重”中，窗口的起始时间点并不确定，因此在“动态时间窗口去重”的指标计算中，每次统计时，等价于要同时计算n个“固定时间窗口去重”的结果，此系数n等于需要的最大的时间窗口宽度。


### 基础算法

数据量小：轻度汇总+即时统计
数据量大：轻度汇总+各粒度聚合统计+即时查询

#### 固定窗口去重

假设，现需要统计“下单人数”，指标的时间维度的粒度为d（天），统计周期为1d，非时间维度包含省份、城市、和地区，且需要支持不同维度的组合，即该指标在Cube中存在多个不同的统计粒度。

#### 动态窗口去重

以对应时间维度的粒度为分区，如：d（天），将当天视为时间窗口的结束时间，并以结束时间作为分区键，统计汇总所有隶属于当天分区的数据（即所有以当天为结束时间的时间窗口）。查询时，以结束时间为分区键条件进行查询。


#### 优缺点

优点
1. 查询效率高：针对每个统计粒度的查询都能通过点查、或即时统计，直接获取结果，查询效率高
缺点
1. Cube表的数量和统计粒度数量成正比：每个OLAP Cube都只支持点查，Cube的数量和统计粒度的数量成正相关
2. 维度数量增加时，会出现存储爆炸：当维度数量增加时，统计粒度的种类也随之迅速增加，为了保证查询效率，Cube的数量也会随之增加。[参考链接](https://help.aliyun.com/document_detail/410616.html)


### 高级算法

#### bitmap

利用Bitmap（RoaringBitmap）数据结构，可以将去重的不可加性指标，拆分为可加性指标，即便增加维度数量，也能避免基础算法中的数据量爆炸问题。

由于bitmap具备可加性，因此如果需要多种粒度，只需要统计生成最细粒度的Cube，就可以基于此Cube聚合成为更大粒度的Cube。


##### 优缺点

优点：
1. 数据压缩
2. 自带去重
3. 集合间运算速度快
4. 存在性判断速度快
缺点：
1. 存储数据类型仅为无符号整数


## 切分打标





## 参考链接

1. [CSDN-数仓实战-最近N天uv优化策略](https://blog.csdn.net/qq_36893938/article/details/124134575)
2. [实时数仓Hologres-用户行为分析(UV)概述](https://help.aliyun.com/document_detail/410616.html)
3. [云原生大数据计算服务 MaxCompute-长周期指标的计算优化方案](https://help.aliyun.com/document_detail/58740.html)
