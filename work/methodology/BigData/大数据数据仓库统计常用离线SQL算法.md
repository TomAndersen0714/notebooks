# 数据仓库统计常用离线SQL算法


## 去重计数

每次统计时，计算与统计时间点距离指定时间长度的起始时间点，到当前统计时间点之间的去重计数时，如果此时间窗口的长度固定，则是“固定时间窗口去重”，相反如果时间窗口的长度不固定，则称为“动态时间窗口去重”。

假设，指标统计时的时间维度粒度为d（天），统计周期为1d（即T+1统计），则指标“每天的近七天网页访问uv数”就属于“固定时间窗口去重”，即每天统计过去7天的去重计数。

而在“动态时间窗口去重”中，每次统计时，虽然时间窗口的结束时间点依旧是统计时间点，但起始时间点并不固定，可以是某固定范围内的任何一点，因此在“动态时间窗口去重”的指标计算中，每次统计时等价于要计算多个“固定时间窗口去重”的指标，此倍数等于最大的时间窗口长度。

### 固定范围去重

假设，现需要统计“下单人数”，指标的时间维度的粒度为d（天），统计周期为1d，非时间维度包含省份、城市、和地区，且非时间维度需要支持不同维度的组合，即该指标存在多个不同的统计粒度。


数据量小：轻度汇总+即时统计

数据量大：轻度汇总+聚合统计+即时查询

优点：
1. 针对每个统计粒度的查询都能直接获取结果，查询效率高

缺点：
1. OLAP Cube只支持对应粒度的点查，不支持其他粒度的聚合等操作
2. 当维度数量增加时，即同时维度的组合方式、统计粒度种类增加时，统计表（Cube）的数量也会随之变多，容易出现存储爆炸。[参考链接](https://help.aliyun.com/document_detail/410616.html)



### 动态范围去重

以对应时间维度的粒度为分区，如：天，将当天视为时间窗口的结束时间，并以结束时间作为分区键，统计汇总所有隶属于当天分区的数据（即所有以当天为结束时间的时间窗口）。

查询时，以结束时间为分区键条件进行查询。

优点：
1. 针对每个统计粒度的查询都能直接获取结果，查询效率高

缺点：
1. OLAP Cube只支持对应粒度的点查，不支持其他粒度的聚合等操作
2. 数据量，随着动态范围宽度的变化而变化，动态范围的大小，直接就是统计结果数据量系数
3. 当维度数量增加时，即同时维度的组合方式、统计粒度种类增加时，统计表（Cube）的数量也会随之变多，容易出现存储爆炸。[参考链接](https://help.aliyun.com/document_detail/410616.html)



## 新增计数




## 切分打标





## 参考链接

1. [CSDN-数仓实战-最近N天uv优化策略](https://blog.csdn.net/qq_36893938/article/details/124134575)
2. [实时数仓Hologres-用户行为分析(uv)概述](https://help.aliyun.com/document_detail/410616.html)
3. [云原生大数据计算服务 MaxCompute-长周期指标的计算优化方案](https://help.aliyun.com/document_detail/58740.html)
